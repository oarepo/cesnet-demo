#!/usr/bin/env bash

set -e

cmd=$1

run_post_install_hooks() {
  # execute post install scripts
  for f in /etc/pre_run.d/*.sh; do
    if ! bash "$f" -H; then
      echo "failed to execute: ${f}. exiting..."
      exit 1
    fi
  done
}

case $cmd in
"wsgi")
  run_post_install_hooks
  gunicorn -u invenio -c /etc/gunicorn/config.py -w 2 -b 0.0.0.0:5000 cesnet_demo.wsgi
  ;;
"debug")
  # TODO: move to base image
  run_post_install_hooks
  export FLASK_ENV=development
  # Start Worker and Server
  celery worker -A invenio_app.celery -l INFO & pid_celery=$!
  invenio run -h 0.0.0.0\
       --cert /etc/nginx/test.crt \
       --key /etc/nginx/test.key & pid_server=$!
  trap 'kill $pid_celery $pid_server &>/dev/null' EXIT
  wait $pid_celery $pid_server
  ;;
"celery")
  celery worker -A invenio_app.celery --loglevel="${INVENIO_CELERY_LOG_LEVEL:-INFO}"
  ;;
"deploy")
  export DEPLOY=True
  run_post_install_hooks
  ;;
esac
